Title: I got paid to work on Open Source #2
Date: 2021-03-19T09:00:00+04:00
Category: Logiciel

<figure style="float:right; width: 40%">
    <img title="urllib3 logo" src="{filename}/images/urllib3-logo.svg" style="width: 100%; max-height: 300px; height: auto; padding: 0" />
</figure>

urllib3 is a HTTP client written in Python. We get [millions of downloads every day](https://pypistats.org/top), 500k GitHub repositories depend on us, and popular libraries like requests and boto3 use us for performing secure HTTP requests. In short, urllib3 is **Python’s most depended-on HTTP client library**.

We’re currently working on a [v2 version that will be more modern and secure](https://urllib3.readthedocs.io/en/latest/v2-roadmap.html). An important part of security is our TLS support. We had already made progress here:

  * Seth, our lead maintainer, made TLS 1.2+ mandatory by default,
  * Hasan, another urllib3 maintainer, started removing support for common names, a TLS feature that was deprecated 20 years ago.

However, another feature was still missing: using Python’s [SSLContext](https://docs.python.org/3/library/ssl.html#ssl.SSLContext) to match hostnames whenever possible. Indeed, Python only added hostname matching in 2011, when Python 2.5 was still supported. Python’s ssl module has improved a lot since then, and we want to rely on it for increased security.

This is a hard problem to tackle, as urllib3 supports many TLS features. We have three TLS backend (Python’s ssl, pyOpenSSL and SecureTransport), support alternate hostnames, fingerprints, SNI, HTTPS proxies and TLS-in-TLS. And most of those features were built when old Python 2 versions were supported, which makes the code complicated. Changing anything here requires a lot of time and energy in order to avoid breaking things. I don’t usually have that time and energy: as a working parent, being able to actually focus on urllib3 for hours is really rare.

## Sponsors

I can’t understate how important the sponsoring we receive is. As you'll see below, our sponsors have a very real effect on urllib3. Thank you!

Last week, I had a great opportunity to work on urllib3 as I was teaching a NLP course part-time in the university I graduated from. This left me with about 20 hours to focus on urllib3, for which <a href="https://opencollective.com/urllib3/expenses/36264">I will get paid $800 pre-taxes</a>. Note that I'm talking a lot about myself here, but none of that would have been possible without the reviews of Seth M. Larson, our lead maintainer. Thank you, Seth!

## 100% coverage

One small but important thing that I did was to maintain 100% coverage (<a href="https://github.com/urllib3/urllib3/pull/2167">#2167</a>, <a href="https://github.com/urllib3/urllib3/pull/2174">#2174</a>). 100% coverage is underrated, and is often thought to be more effort than it’s worth. While it certainly takes discipline and requires marking specific lines as uncovered, the main benefit is that when a line is not covered, you *know* that it’s a bug. This helped us find bugs in the past, which is why when coverage is not at 100% I stop what I’m doing and fix it.

I also contacted GitHub Support, which is something that I meant to do for weeks. They helped us understand that our PR checks were all messed up because we had required the codecov check. They don't know yet why this is causing issues, but it certainly was preventing us from merging PRs correctly, as most checks were just showing as "expected" most of the time. Fixing that was instrumental in getting the PRs below merged efficiently.

## Preparatory work

With the coverage out of the way, the rest of the focused time I had allowed me to gradually work towards the `SSLContext` goal:

* I first improved the documentation of two options in <a href="https://github.com/urllib3/urllib3/pull/2169">#2169</a> (documenting things requires understanding them, so that took a lot of time but helped a lot with the other steps)
* I finished the simplification of `check_hostname` (started in <a href="https://github.com/urllib3/urllib3/pull/2159">#2159</a>, finished in <a href="https://github.com/urllib3/urllib3/pull/2170">#2170</a>). This also was crucial to understand that `SSLContext.check_hostname` was now always available and that we were just setting it to False
* I simplified the `server_hostname` handling code thanks to a Python 3.5 improvement (<a href="https://github.com/urllib3/urllib3/pull/2176">#2176</a>)
* I removed an old OpenSSL 0.9.8 check (<a href="https://github.com/urllib3/urllib3/pull/2173">#2173</a>)

## CVE-2021-28363

Note that at that point, I had not achieved much. However, not only this simplified our code a lot, but I also understood it much better than before. This clarity about our code and its limitations allowed me to find <a href="https://github.com/urllib3/urllib3/security/advisories/GHSA-5phf-pp7p-vc2r">CVE-2021-28363</a>, a severe vulnerability for TLS-in-TLS proxy support where we failed to match hostnames in the default case. I would never have found that before because the way we matched hostnames was unclear to me until now.

Jorge, the urllib3 maintainer that added TLS-in-TLS support to urllib3, fixed that quickly, and 1.26.4 is now released with the fix, and already represents 90% of our downloads.

## Leaning on SSLContext

Armed with that clarity, I then added the last missing pieces for `SSLContext` support:

* I moved one SNI feature to our TLS backends in <a href="https://github.com/urllib3/urllib3/pull/2177">#2177</a> (I closed the PR because those commits were merged as part of #2178)
* I actually relied on `SSLContext` to match hostnames for us, in the cases where it’s possible, which was difficult since there are four cases where it’s not! (<a href="https://github.com/urllib3/urllib3/pull/2178">#2178</a>)

I also realized that common name removal wasn’t complete, which I fixed in <a href="https://github.com/urllib3/urllib3/pull/2186">#2186</a>.

## Python's ssl bug

At this point, something interesting happened. We merged <a href="https://github.com/urllib3/urllib3/pull/2186">#2186</a> and <a href="https://github.com/urllib3/urllib3/pull/2178">#2178</a> separately, as all tests passed for those two PRs. But after the merges, the main branch was failing! Indeed, we were now relying on Python’s `hostname_checks_common_name` flag to remove support for common names on Python 3.7+. But that did not work! It took some time to realise that I had encountered a bug in Python’s ssl module. This was quite surprising: finding a Python ssl bug is a bit like finding a compiler bug, something that is not supposed to happen!

So that bug is <a href="https://bugs.python.org/issue43522">https://bugs.python.org/issue43522</a>, which is going to be fixed for Python 3.10 and will probably going to lead to a fix in OpenSSL itself. On the one hand, this means we won’t be able to lean on `SSLContext` as much as we would have liked, but on the other hand one of our goal for v2 was increased security, and my 20 hours of work will ultimately result in increasing security for urllib3, Python and OpenSSL. Not bad!

Time and time again, we find that investing in open source is <a href="https://vorpus.org/blog/the-unreasonable-effectiveness-of-investment-in-open-source-infrastructure/">unreasonably effective</a>. Consider investing yourself by <a href="https://github.com/sponsors/urllib3">sponsoring urllib3 on GitHub Sponsors</a>!

<!-- vim: spelllang=en
-->
